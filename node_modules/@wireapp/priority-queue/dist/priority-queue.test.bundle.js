var PriorityQueue=function(e){var t={};function r(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(o,i,function(t){return e[t]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=5)}([function(e,t,r){"use strict";function o(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0}),o(r(2)),o(r(1)),o(r(3))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.LOW=0]="LOW",e[e.MEDIUM=5]="MEDIUM",e[e.HIGH=9]="HIGH"}(t.Priority||(t.Priority={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(1);t.Item=class{constructor(){this.fn=()=>{},this.priority=o.Priority.MEDIUM,this.reject=()=>{},this.resolve=()=>{},this.retry=1/0,this.timestamp=0}toString(){return`\n    label=${this.label},\n    priority=${this.priority},\n    timestamp=${this.timestamp},\n    retry=${this.retry},\n    fn=${this.fn.toString().replace(/(\r\n|\n|\r|\s+)/gm," ")},`}}},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(4)),s=r(2),a=r(1);t.PriorityQueue=class{constructor(e){this.logger=n.default("@wireapp/priority-queue/PriorityQueue",{logger:console,markdown:!1}),this.config={comparator:(e,t)=>e.priority===t.priority?e.timestamp-t.timestamp:t.priority-e.priority,maxRetries:0,maxRetryDelay:Number.MAX_SAFE_INTEGER,retryDelay:1e3,retryGrowthFactor:1.3},this.isRunning=!1,this.queue=[],this.config=Object.assign(Object.assign({},this.config),e)}add(e,t=a.Priority.MEDIUM,r){return new Promise((o,i)=>{const n=new s.Item;n.fn=e,n.label=r,n.priority=t,n.reject=i,n.resolve=o,n.retry=0,n.timestamp=Date.now()+this.size,this.queue.push(n),this.queue.sort(this.config.comparator),this.isRunning||(this.isRunning=!0,this.processList())})}delete(e){this.queue=this.queue.filter(t=>t.label!==e)}deleteAll(){this.queue=[]}get all(){return this.queue}get first(){return this.queue[0]}get last(){return this.queue[this.queue.length-1]}get size(){return this.queue.length}processList(){return o(this,void 0,void 0,(function*(){const e=this.first;if(e)try{e.resolve(yield e.fn()),this.queue.shift(),this.processList()}catch(t){e.retry>=this.config.maxRetries?(this.queue.shift(),e.reject(t),this.processList()):(this.logger.log(`Retrying item "${e}"`),setTimeout(()=>this.processList(),this.getGrowingDelay(e.retry)),e.retry++)}else this.isRunning=!1}))}getGrowingDelay(e){const t=e<1?this.config.retryDelay:this.config.retryDelay*e*this.config.retryGrowthFactor;return Math.min(t,this.config.maxRetryDelay)}toString(){return this.queue.map((e,t)=>`"${t}": ${e.toString()}`).join("\r\n")}}},function(module,exports,__webpack_require__){var e;window,e=function(){return function(e){var t={};function r(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(o,i,function(t){return e[t]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){var o,i=r(1)(),n=r(3),s=r(5),a=r(8)();i.prefixColors=["#F2777A","#F99157","#FFCC66","#99CC99","#66CCCC","#6699CC","#CC99CC"],i._setPrefixRegExps=function(){try{a.localStorage&&"string"==typeof a.localStorage.getItem("debug")&&(i._prefixRegExps=[],a.localStorage.getItem("debug").split(",").forEach((function(e){var t="enable";"-"===(e=e.trim())[0]&&(e=e.substr(1),t="disable");var r=i._prepareRegExpForPrefixSearch(e);i._prefixRegExps.push({type:t,regExp:r})})))}catch(e){}},i._getNextPrefixColor=(o=0,function(){return o+=1,i.prefixColors[o%i.prefixColors.length]}),i.prototype._getDecoratedPrefix=function(){var e=[];return s()?(e.push("%c"+this.opts.prefix+"%c "),e.push("color:"+this.opts.prefixColor+"; font-weight:bold;","")):e.push("["+this.opts.prefix+"] "),e},i.prototype._prepareOutput=function(e){var t,r=this._getDecoratedPrefix();return"string"==typeof e[0]?this.opts.markdown&&s()?(t=n.parse(e[0]),r[0]=r[0]+t.text,r=r.concat(t.styles)):r[0]=r[0]+e[0]:r.push(e[0]),1<e.length&&(r=r.concat(e.slice(1))),r},i._setPrefixRegExps(),e.exports=i},function(e,t,r){var o=r(2);e.exports=function(){function e(t,r){return this instanceof e?e._isPrefixAlreadyInUse(t)?e._getInstanceByPrefix(t):(this.opts=e._normalizeOpts(t,r),this.state=e._getInitialState(this.opts),e._decorateLoggerMethods(this),e._instances.push(this),this):new e(t,r)}return e.transports=[],e._instances=[],e._prefixRegExps=[],e._prepareRegExpForPrefixSearch=function(e){return new RegExp("^"+e.replace(/\*/g,".*?")+"$")},e._isPrefixAlreadyInUse=function(t){return e._instances.some((function(e){return e.opts.prefix===t}))},e._getInstanceByPrefix=function(t){return e._instances.filter((function(e){return e.opts.prefix===t}))[0]},e._normalizeOpts=function(t,r){if("string"!=typeof t)throw new TypeError("prefix must be a string");var o=void 0===(r=r||{}).markdown||Boolean(r.markdown),i=r.prefixColor||e._getNextPrefixColor();return{logger:r.logger||console,markdown:o,plaintext:Boolean(r.plaintext),prefix:t,prefixColor:i}},e._getInitialState=function(t){return{isEnabled:e._getEnableState(t)}},e._getEnableState=function(t){var r=!1;return e._prefixRegExps.forEach((function(e){"enable"===e.type&&e.regExp.test(t.prefix)?r=!0:"disable"===e.type&&e.regExp.test(t.prefix)&&(r=!1)})),r},e._decorateLoggerMethods=function(t){var r=t.opts.logger,i=Object.keys(r).filter((function(e){return"function"==typeof r[e]}));0===i.length&&(i=["debug","log","warn","error","info"]),i.forEach((function(i){t[i]=function(){var t=o(arguments),n=this.opts.prefix;if(e.transports.length){var s="["+n+"] "+t.filter((function(e){return"object"!=typeof e})).join(" ");e.transports.forEach(function(e){e({state:this.state,instance:n,level:i,args:t,msg:s})}.bind(this))}if(this.state.isEnabled){var a=this._prepareOutput(t,i);r[i].apply(r,a)}}}))},e}},function(e,t){e.exports=function(e){return Array.prototype.slice.call(e,0)}},function(e,t,r){var o=[];function i(e){return function(t){return o.push(e),o.push(""),"%c"+t+"%c"}}var n=new(r(4))({renderer:{"*":i("font-weight:bold;"),_:i("font-style:italic;"),"`":i("background-color:rgba(255,204,102, 0.1);color:#FFCC66;padding:2px 5px;border-radius:2px;")}});e.exports={parse:function(e){var t={text:n.parse(e),styles:[].concat(o)};return o.length=0,t}}},function(e,t){var r=/([_*`\\]|[^_*`\\]+)/g,o=/[_*`]/;function i(e){this.renderer=e.renderer}function n(e){return o.test(e)}i.prototype.parse=function(e){var t,o,i,s=e.match(r),a=this.renderer,u="",c=[],f={},p=0;function l(e){for(var r="";t&&t.tag!==e;)r=t.tag+t.text+r,f[t.tag]=!1,t=c.pop();return r}for(;i=s[p];){if(o="",p++,n(i))if(f[i])o=l(i),o=a[t.tag](t.text+o),f[i]=!1,t=c.pop();else{var d="";if("`"===i){var h=s.indexOf(i,p);-1!==h&&(u+=l(),d=s.slice(p,h).join(""),p=h)}t&&c.push(t),f[i]=!0,t={tag:i,text:d}}else if("\\"===(o=i)){var y=s[p];(n(y)||"\\"===y)&&(o=y,p++)}o&&(t?t.text+=o:u+=o,o="")}return u+l()},e.exports=i},function(e,t,r){var o=r(6),i=r(7);e.exports=function(){return o()||i()}},function(e,t){e.exports=function(){try{return"WebkitAppearance"in document.documentElement.style&&!/Edge/.test(navigator.userAgent)}catch(e){return!1}}},function(e,t){e.exports=function(){try{return/firefox\/(\d+)/i.test(navigator.userAgent)}catch(e){return!1}}},function(e,t,r){(function(t){function r(e,t){return"object"==typeof e&&e.self===e&&e||"object"==typeof t&&t.global===t&&t||this}e.exports=r.bind(this,self,t),e.exports.getGlobal=r}).call(this,r(9))},function(ob,pb){var qb;qb=function(){return this}();try{qb=qb||Function("return this")()||eval("this")}catch(ob){"object"==typeof window&&(qb=window)}ob.exports=qb}])},module.exports=e()},function(e,t,r){const o=r(6);o.keys().forEach(o)},function(e,t,r){var o={"./PriorityQueue.test.js":7};function i(e){var t=n(e);return r(t)}function n(e){if(!r.o(o,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return o[e]}i.keys=function(){return Object.keys(o)},i.resolve=n,e.exports=i,i.id=6},function(e,t,r){"use strict";r.r(t);var o=r(0);beforeAll(()=>jasmine.DEFAULT_TIMEOUT_INTERVAL=1e4),describe("PriorityQueue",()=>{describe('"constructor"',()=>{it("supports a custom retry delay of 3 seconds",e=>{let t=!0;setTimeout(()=>t=!1,1500),new o.PriorityQueue({maxRetries:1/0,retryDelay:3e3}).add(()=>new Promise((r,o)=>{t?o(new Error("Promise is locked.")):(r("Promise successfully executed."),e())}))}),it("supports limiting the amount of retries",async()=>{const e=jasmine.createSpy().and.returnValue(Promise.reject(new Error("Error"))),t=new o.PriorityQueue({maxRetries:1});try{await t.add(e),fail()}catch(r){expect(t.size).toBe(0),expect(e.calls.count()).toBe(2)}})}),describe('"add"',()=>{it("adds objects",()=>{const e=new o.PriorityQueue;e.isPending=!0,e.add(()=>"ape"),e.add(()=>"cat"),e.add(()=>"dog"),e.add(()=>"zebra"),expect(e.size).toBe(4)}),it("adds objects with priorities",async()=>{const e=new o.PriorityQueue;e.isPending=!0,e.add(()=>"ape"),e.add(()=>"cat",o.Priority.LOW),e.add(()=>"dog",o.Priority.HIGH),e.add(()=>"zebra");const t=await e.first.fn();expect(t).toBe("dog");const r=await e.last.fn();expect(r).toBe("cat")}),it("works with thunked Promises",async()=>{const e=new o.PriorityQueue,t=await Promise.all([e.add(()=>Promise.resolve("ape")),e.add(()=>Promise.resolve("cat")),e.add(()=>Promise.resolve("dog")),e.add(()=>Promise.resolve("zebra"))]);expect(t[0]).toBe("ape"),expect(t[1]).toBe("cat"),expect(t[2]).toBe("dog"),expect(t[3]).toBe("zebra")})}),describe('"run"',()=>{it("executes an item from the queue",e=>{const t=new o.PriorityQueue;t.add(()=>Promise.resolve("ape").then(e())),t.add(()=>"cat"),t.add(()=>"dog"),t.add(()=>"zebra")}),it("executes an item from the queue with different priorities",e=>{const t=new o.PriorityQueue;t.add(()=>Promise.resolve("one").then(e=>(expect(e).toBe("one"),"one")),o.Priority.HIGH),t.add(()=>Promise.resolve("two").then(e=>(expect(e).toBe("two"),"two")),o.Priority.MEDIUM),t.add(()=>Promise.resolve("three").then(t=>{expect(t).toBe("three"),e()}),o.Priority.LOW)}),it("retries on error until the error gets resolved",e=>{let t=!0;const r=()=>new Promise(e=>{t=!1,e()}),i=new o.PriorityQueue({maxRetries:1/0});i.add(()=>new Promise((r,o)=>{t?o(new Error("Promise is locked.")):(r("Promise successfully executed."),e())})),setTimeout(()=>i.add(r,o.Priority.HIGH),200)}),it("works with error-catching Promises",e=>{const t=new o.PriorityQueue;function r(e){return new Promise((t,r)=>{isNaN(e)?r(new TypeError("Not a Number")):t(e)})}t.add(()=>r("A").catch(()=>r(42)).then(e=>expect(e).toBe(42)),o.Priority.HIGH),t.add(()=>Promise.resolve("two").then(e=>expect(e).toBe("two")),o.Priority.MEDIUM),t.add(()=>Promise.resolve("three").then(()=>e()),o.Priority.LOW)}),it("executes a high priority element prior to other running elements ",e=>{const t=new o.PriorityQueue,r=()=>Promise.resolve("three").then(t=>{expect(t).toBe("three"),e()});t.add(()=>Promise.resolve("one").then(e=>expect(e).toBe("one"))),t.add(()=>Promise.reject(new Error("two"))),setTimeout(()=>t.add(r,o.Priority.HIGH),1e3)})}),describe('"size"',()=>{it("returns the size of the items left after Promise execution",e=>{let t=!0;const r=()=>new Promise(e=>{t=!1,e()}),i=new o.PriorityQueue({maxRetries:1/0,retryDelay:100});setTimeout(()=>i.add(r,o.Priority.HIGH),1e3),i.add(()=>new Promise((e,r)=>{t?r(new Error("Promise is locked.")):e("Promise successfully executed.")})).then(()=>{expect(i.size).toBe(0),e()})})}),describe('"comparator"',()=>{it("uses a descending priority order by default",async()=>{const e=new o.PriorityQueue;e.isRunning=!0,e.add(()=>"ape",o.Priority.HIGH),e.add(()=>"cat"),e.add(()=>"dog"),e.add(()=>"zebra",o.Priority.LOW);const t=await e.last.fn();expect(t).toBe("zebra");const r=await e.first.fn();expect(r).toBe("ape")}),it("supports a custom comparator",async()=>{const e=new o.PriorityQueue({comparator:(e,t)=>e.priority-t.priority});e.isRunning=!0,e.add(()=>"ape",o.Priority.HIGH),e.add(()=>"cat"),e.add(()=>"dog"),e.add(()=>"zebra",o.Priority.LOW);const t=await e.first.fn();expect(t).toBe("zebra");const r=await e.last.fn();expect(r).toBe("ape")}),it("continues after the maximum amount of retries",e=>{const t=new o.PriorityQueue({maxRetries:3}),r=()=>Promise.resolve("three").then(t=>{expect(t).toBe("three"),e()});t.add(()=>Promise.resolve("one").then(e=>(expect(e).toBe("one"),"one"))),t.add(()=>Promise.reject(new Error("two")).then(e=>(expect(e).toBe("two"),"two"))),setTimeout(()=>t.add(r),1e3)})})})}]);
//# sourceMappingURL=priority-queue.test.bundle.js.map